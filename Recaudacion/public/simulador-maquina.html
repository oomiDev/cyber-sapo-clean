<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Simulador de M√°quina Expendedora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .machine-container {
            background: #2c3e50;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            padding: 30px;
            margin: 20px auto;
            max-width: 600px;
            border: 3px solid #34495e;
        }
        
        .machine-screen {
            background: #1a1a1a;
            border: 5px solid #444;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            min-height: 200px;
        }
        
        .credit-display {
            font-size: 2em;
            text-align: center;
            margin: 20px 0;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }
        
        .pulse-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            font-size: 2em;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(255,107,107,0.3);
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }
        
        .pulse-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(255,107,107,0.4);
            background: linear-gradient(45deg, #ff5252, #d63031);
        }
        
        .pulse-btn:active {
            transform: translateY(0);
            box-shadow: 0 5px 10px rgba(255,107,107,0.3);
        }
        
        .config-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status-online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .status-offline { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }
        
        .log-success { color: #00ff00; }
        .log-error { color: #ff6b6b; }
        .log-info { color: #74b9ff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center text-white mb-4">
            <h1><i class="fas fa-robot"></i> Simulador de M√°quina Expendedora</h1>
            <p class="lead">Simula pulsos de cr√©dito (tecla M) y observa el dashboard en tiempo real</p>
        </div>

        <div class="machine-container">
            <!-- Panel de Configuraci√≥n -->
            <div class="config-panel">
                <h5 class="text-white mb-3"><i class="fas fa-cog"></i> Configuraci√≥n de M√°quina</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label text-white">C√≥digo de M√°quina:</label>
                        <input type="text" id="codigoMaquina" class="form-control" value="MAQ001" placeholder="Ej: MAQ001">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Valor por Cr√©dito (‚Ç¨):</label>
                        <input type="number" id="valorCredito" class="form-control" value="0.50" step="0.01" min="0.01">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label text-white">URL del Servidor:</label>
                        <select id="urlServidor" class="form-control">
                            <option value="http://localhost:3000">Local MongoDB (localhost:3000)</option>
                            <option value="http://localhost:3002">Local Test (localhost:3002)</option>
                                                                                    <option value="https://sistema-recaudacion-maquinas-production.up.railway.app">Nube (Railway)</option>
                            <option value="https://cyber-sapo-clean.onrender.com" selected>Nube (Render)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white">Estado:</label>
                        <div class="mt-2">
                            <span id="statusIndicator" class="status-indicator status-offline"></span>
                            <span id="statusText" class="text-white">Desconectado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pantalla de la M√°quina -->
            <div class="machine-screen">
                <div class="text-center">
                    <h4>üé∞ M√ÅQUINA EXPENDEDORA VIRTUAL</h4>
                    <div class="credit-display">
                        CR√âDITOS: <span id="creditCount">0</span>
                    </div>
                    <div class="mb-3">
                        <strong>M√°quina:</strong> <span id="displayMaquina">MAQ001</span><br>
                        <strong>Total Recaudado:</strong> ‚Ç¨<span id="totalRecaudado">0.00</span>
                    </div>
                </div>
                
                <!-- Log de Actividad -->
                <div style="max-height: 150px; overflow-y: auto; border-top: 1px solid #333; padding-top: 10px;">
                    <div id="activityLog">
                        <div class="log-entry log-info">Sistema iniciado - Esperando conexi√≥n...</div>
                    </div>
                </div>
            </div>

            <!-- Controles -->
            <div class="text-center">
                <button id="pulseBtn" class="pulse-btn" disabled>
                    <i class="fas fa-coins"></i> PULSAR M (CR√âDITO)
                </button>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <button id="connectBtn" class="btn btn-success w-100">
                            <i class="fas fa-plug"></i> Conectar
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button id="resetBtn" class="btn btn-warning w-100">
                            <i class="fas fa-redo"></i> Reiniciar
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button id="autoBtn" class="btn btn-info w-100">
                            <i class="fas fa-play"></i> Auto (5s)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instrucciones -->
        <div class="card bg-dark text-white mt-4">
            <div class="card-body">
                <h5><i class="fas fa-info-circle"></i> Instrucciones de Uso</h5>
                <ul>
                    <li><strong>Conectar:</strong> Establece conexi√≥n con el servidor</li>
                    <li><strong>Pulsar M:</strong> Simula insertar una moneda (genera un pulso)</li>
                    <li><strong>Auto:</strong> Genera pulsos autom√°ticamente cada 5 segundos</li>
                    <li><strong>Dashboard:</strong> Ve los datos en tiempo real en <a href="http://localhost:3000" target="_blank" class="text-info">http://localhost:3000</a></li>
                    <li><strong>Teclado:</strong> Tambi√©n puedes usar la tecla <kbd>M</kbd> para generar pulsos</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class MaquinaSimulador {
            constructor() {
                this.creditos = 0;
                this.totalRecaudado = 0;
                this.conectado = false;
                this.autoMode = false;
                this.autoInterval = null;
                
                this.initEventListeners();
                this.updateDisplay();
            }
            
            initEventListeners() {
                // Botones
                document.getElementById('connectBtn').addEventListener('click', () => this.toggleConnection());
                document.getElementById('pulseBtn').addEventListener('click', () => this.sendPulse());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
                document.getElementById('autoBtn').addEventListener('click', () => this.toggleAuto());
                
                // Tecla M para pulsos
                document.addEventListener('keydown', (e) => {
                    if (e.key.toLowerCase() === 'm' && this.conectado) {
                        this.sendPulse();
                    }
                });
                
                // Actualizar configuraci√≥n
                document.getElementById('codigoMaquina').addEventListener('change', () => this.updateDisplay());
                document.getElementById('valorCredito').addEventListener('change', () => this.updateDisplay());
            }
            
            async toggleConnection() {
                if (this.conectado) {
                    this.disconnect();
                } else {
                    await this.connect();
                }
            }
            
            async connect() {
                const url = document.getElementById('urlServidor').value;
                this.log('Conectando al servidor...', 'info');
                
                try {
                    // Probar conexi√≥n
                    const response = await fetch(`${url}/api/pulsos/test`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok || response.status === 404) {
                        this.conectado = true;
                        this.updateConnectionStatus();
                        this.log('‚úÖ Conectado al servidor exitosamente', 'success');
                        document.getElementById('connectBtn').innerHTML = '<i class="fas fa-unlink"></i> Desconectar';
                        document.getElementById('connectBtn').className = 'btn btn-danger w-100';
                        document.getElementById('pulseBtn').disabled = false;
                    } else {
                        throw new Error(`Error ${response.status}`);
                    }
                } catch (error) {
                    this.log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    this.conectado = false;
                    this.updateConnectionStatus();
                }
            }
            
            disconnect() {
                this.conectado = false;
                this.stopAuto();
                this.updateConnectionStatus();
                this.log('üîå Desconectado del servidor', 'info');
                document.getElementById('connectBtn').innerHTML = '<i class="fas fa-plug"></i> Conectar';
                document.getElementById('connectBtn').className = 'btn btn-success w-100';
                document.getElementById('pulseBtn').disabled = true;
            }
            
            async sendPulse() {
                if (!this.conectado) {
                    this.log('‚ùå No conectado al servidor', 'error');
                    return;
                }
                
                const codigoMaquina = document.getElementById('codigoMaquina').value;
                const valorCredito = parseFloat(document.getElementById('valorCredito').value);
                const url = document.getElementById('urlServidor').value;
                
                const pulsoData = {
                    codigoMaquina: codigoMaquina,
                    valor: valorCredito,
                    timestamp: new Date().toISOString(),
                    tipo: 'credito'
                };
                
                try {
                    const response = await fetch(`${url}/api/pulsos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pulsoData)
                    });
                    
                    if (response.ok) {
                        this.creditos++;
                        this.totalRecaudado += valorCredito;
                        this.updateDisplay();
                        this.log(`üí∞ Pulso enviado: ‚Ç¨${valorCredito.toFixed(2)} - Total: ${this.creditos}`, 'success');
                        
                        // Efecto visual
                        this.pulseEffect();
                    } else {
                        const error = await response.text();
                        this.log(`‚ùå Error enviando pulso: ${error}`, 'error');
                    }
                } catch (error) {
                    this.log(`‚ùå Error de red: ${error.message}`, 'error');
                }
            }
            
            toggleAuto() {
                if (this.autoMode) {
                    this.stopAuto();
                } else {
                    this.startAuto();
                }
            }
            
            startAuto() {
                if (!this.conectado) {
                    this.log('‚ùå Conecta primero para usar modo autom√°tico', 'error');
                    return;
                }
                
                this.autoMode = true;
                document.getElementById('autoBtn').innerHTML = '<i class="fas fa-stop"></i> Parar Auto';
                document.getElementById('autoBtn').className = 'btn btn-danger w-100';
                
                this.autoInterval = setInterval(() => {
                    this.sendPulse();
                }, 5000);
                
                this.log('ü§ñ Modo autom√°tico activado (cada 5s)', 'info');
            }
            
            stopAuto() {
                this.autoMode = false;
                if (this.autoInterval) {
                    clearInterval(this.autoInterval);
                    this.autoInterval = null;
                }
                
                document.getElementById('autoBtn').innerHTML = '<i class="fas fa-play"></i> Auto (5s)';
                document.getElementById('autoBtn').className = 'btn btn-info w-100';
                this.log('‚èπÔ∏è Modo autom√°tico desactivado', 'info');
            }
            
            reset() {
                this.creditos = 0;
                this.totalRecaudado = 0;
                this.updateDisplay();
                this.log('üîÑ Contador reiniciado', 'info');
            }
            
            updateDisplay() {
                const codigoMaquina = document.getElementById('codigoMaquina').value;
                document.getElementById('creditCount').textContent = this.creditos;
                document.getElementById('displayMaquina').textContent = codigoMaquina;
                document.getElementById('totalRecaudado').textContent = this.totalRecaudado.toFixed(2);
            }
            
            updateConnectionStatus() {
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                
                if (this.conectado) {
                    indicator.className = 'status-indicator status-online';
                    text.textContent = 'Conectado';
                } else {
                    indicator.className = 'status-indicator status-offline';
                    text.textContent = 'Desconectado';
                }
            }
            
            log(message, type = 'info') {
                const logContainer = document.getElementById('activityLog');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Mantener solo las √∫ltimas 20 entradas
                while (logContainer.children.length > 20) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
            
            pulseEffect() {
                const btn = document.getElementById('pulseBtn');
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    btn.style.transform = 'scale(1)';
                }, 100);
            }
        }
        
        // Inicializar simulador
        const simulador = new MaquinaSimulador();
        
        // Mensaje de bienvenida
        setTimeout(() => {
            simulador.log('üéÆ Simulador listo - Configura y conecta para empezar', 'info');
        }, 1000);
    </script>
</body>
</html>
