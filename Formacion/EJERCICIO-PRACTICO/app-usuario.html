<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± CYBER SAPO - App Usuario</title>
    <link rel="stylesheet" href="css/estilos.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="app-body">
    <div class="container">
        <!-- Header de la App -->
        <header class="app-header">
            <h1>üì± CYBER SAPO</h1>
            <h2>App del Usuario</h2>
            <div class="estado-conexion">
                <span id="estado-servidor">üî¥ Desconectado</span>
            </div>
        </header>

        <!-- Panel Principal de la App -->
        <main class="app-main">
            <!-- Puntuaciones en Tiempo Real -->
            <section class="puntuaciones-tiempo-real">
                <h3>üèÜ Puntuaciones en Vivo</h3>
                <div id="puntuaciones-container" class="puntuaciones-grid">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </section>

            <!-- Jugador Activo -->
            <section class="jugador-activo-info">
                <h3>üéØ Turno Actual</h3>
                <div id="info-jugador-activo" class="jugador-activo-card">
                    <div class="jugador-avatar">üéÆ</div>
                    <div class="jugador-datos">
                        <span class="nombre" id="nombre-activo">Esperando...</span>
                        <span class="puntuacion" id="puntuacion-activo">0 pts</span>
                    </div>
                </div>
            </section>

            <!-- Historial de Jugadas -->
            <section class="historial-jugadas">
                <h3>üìù √öltimas Jugadas</h3>
                <div id="historial-container" class="historial-lista">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </section>

            <!-- Estad√≠sticas R√°pidas -->
            <section class="estadisticas-rapidas">
                <h3>üìä Estad√≠sticas</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Jugadas</span>
                        <span class="stat-value" id="total-jugadas">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Puntuaci√≥n M√°xima</span>
                        <span class="stat-value" id="puntuacion-maxima">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">L√≠der Actual</span>
                        <span class="stat-value" id="lider-actual">-</span>
                    </div>
                </div>
            </section>

            <!-- Notificaciones -->
            <section class="notificaciones">
                <div id="notificaciones-container" class="notificaciones-lista">
                    <!-- Notificaciones aparecer√°n aqu√≠ -->
                </div>
            </section>
        </main>
    </div>

    <script>
        /**
         * üì± CLASE PRINCIPAL DE LA APP USUARIO
         * Maneja la visualizaci√≥n en tiempo real de las puntuaciones
         */
        class AppUsuarioCyberSapo {
            constructor() {
                this.socket = null;
                this.conectado = false;
                this.estadoJuego = null;
                this.notificacionesActivas = [];
                
                this.inicializar();
            }
            
            /**
             * üöÄ INICIALIZAR APP
             */
            async inicializar() {
                this.log('üì± Inicializando App Usuario...');
                
                // 1. Conectar al servidor
                this.conectarServidor();
                
                // 2. Configurar actualizaciones autom√°ticas
                this.configurarActualizaciones();
                
                this.log('‚úÖ App Usuario inicializada');
            }
            
            /**
             * üîå CONECTAR AL SERVIDOR
             */
            conectarServidor() {
                try {
                    // Crear conexi√≥n Socket.IO
                    this.socket = io('http://localhost:8080');
                    
                    // üü¢ EVENTO: Conexi√≥n establecida
                    this.socket.on('connect', () => {
                        this.conectado = true;
                        this.actualizarEstadoConexion('üü¢ Conectado');
                        this.log('‚úÖ Conectado al servidor');
                        this.mostrarNotificacion('Conectado al servidor', 'success');
                    });
                    
                    // üî¥ EVENTO: Desconexi√≥n
                    this.socket.on('disconnect', () => {
                        this.conectado = false;
                        this.actualizarEstadoConexion('üî¥ Desconectado');
                        this.log('‚ùå Desconectado del servidor');
                        this.mostrarNotificacion('Desconectado del servidor', 'error');
                    });
                    
                    // üìä EVENTO: Estado inicial
                    this.socket.on('estado_inicial', (datos) => {
                        this.log('üìä Estado inicial recibido');
                        this.estadoJuego = datos.data;
                        this.actualizarTodasLasSecciones();
                        this.mostrarNotificacion('Estado del juego cargado', 'info');
                    });
                    
                    // üéØ EVENTO: Puntuaci√≥n actualizada
                    this.socket.on('puntuacion_actualizada', (datos) => {
                        const jugada = datos.data.jugada;
                        this.log(`üéØ ${jugada.jugadorNombre} anot√≥ ${jugada.puntos} pts en hoyo ${jugada.hoyo}`);
                        
                        this.estadoJuego = datos.data.estadoCompleto;
                        this.actualizarTodasLasSecciones();
                        
                        // Mostrar notificaci√≥n de puntuaci√≥n
                        this.mostrarNotificacion(
                            `${jugada.jugadorNombre} anot√≥ ${jugada.puntos} puntos!`,
                            'success'
                        );
                        
                        // Animaci√≥n especial para puntuaciones altas
                        if (jugada.puntos >= 1000) {
                            this.mostrarAnimacionEspecial(jugada);
                        }
                    });
                    
                    // üë§ EVENTO: Jugador cambiado
                    this.socket.on('jugador_cambiado', (datos) => {
                        const jugador = datos.data.jugadorActual;
                        this.log(`üë§ Turno de: ${jugador.nombre}`);
                        
                        this.estadoJuego = datos.data.estadoCompleto;
                        this.actualizarTodasLasSecciones();
                        
                        this.mostrarNotificacion(
                            `Turno de ${jugador.nombre}`,
                            'info'
                        );
                    });
                    
                    // üîÑ EVENTO: Juego reiniciado
                    this.socket.on('juego_reiniciado', (estadoNuevo) => {
                        this.log('üîÑ Juego reiniciado');
                        this.estadoJuego = estadoNuevo;
                        this.actualizarTodasLasSecciones();
                        this.mostrarNotificacion('Nueva partida iniciada', 'info');
                    });
                    
                } catch (error) {
                    this.log(`‚ùå Error conectando: ${error.message}`);
                }
            }
            
            /**
             * ‚è∞ CONFIGURAR ACTUALIZACIONES AUTOM√ÅTICAS
             */
            configurarActualizaciones() {
                // Actualizar estad√≠sticas cada 5 segundos
                setInterval(() => {
                    if (this.estadoJuego) {
                        this.actualizarEstadisticas();
                    }
                }, 5000);
                
                // Limpiar notificaciones viejas cada 10 segundos
                setInterval(() => {
                    this.limpiarNotificacionesViejas();
                }, 10000);
            }
            
            /**
             * üîÑ ACTUALIZAR TODAS LAS SECCIONES
             */
            actualizarTodasLasSecciones() {
                if (!this.estadoJuego) return;
                
                this.actualizarPuntuaciones();
                this.actualizarJugadorActivo();
                this.actualizarHistorial();
                this.actualizarEstadisticas();
            }
            
            /**
             * üèÜ ACTUALIZAR PUNTUACIONES
             */
            actualizarPuntuaciones() {
                const container = document.getElementById('puntuaciones-container');
                container.innerHTML = '';
                
                // Ordenar jugadores por puntuaci√≥n (mayor a menor)
                const jugadoresOrdenados = [...this.estadoJuego.jugadores]
                    .sort((a, b) => b.puntuacion - a.puntuacion);
                
                jugadoresOrdenados.forEach((jugador, index) => {
                    const card = document.createElement('div');
                    card.className = `puntuacion-card ${jugador.activo ? 'activo' : ''}`;
                    
                    // Agregar corona al l√≠der
                    const corona = index === 0 && jugador.puntuacion > 0 ? 'üëë' : '';
                    
                    card.innerHTML = `
                        <div class="posicion">#${index + 1} ${corona}</div>
                        <div class="jugador-info">
                            <div class="nombre">${jugador.nombre}</div>
                            <div class="puntuacion">${jugador.puntuacion.toLocaleString()} pts</div>
                        </div>
                        ${jugador.activo ? '<div class="indicador-turno">üéØ Su turno</div>' : ''}
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            /**
             * üéØ ACTUALIZAR JUGADOR ACTIVO
             */
            actualizarJugadorActivo() {
                const jugadorActivo = this.estadoJuego.jugadores.find(j => j.activo);
                
                if (jugadorActivo) {
                    document.getElementById('nombre-activo').textContent = jugadorActivo.nombre;
                    document.getElementById('puntuacion-activo').textContent = `${jugadorActivo.puntuacion} pts`;
                    
                    // Cambiar color de fondo seg√∫n el jugador
                    const card = document.getElementById('info-jugador-activo');
                    card.className = `jugador-activo-card jugador-${jugadorActivo.id}`;
                }
            }
            
            /**
             * üìù ACTUALIZAR HISTORIAL
             */
            actualizarHistorial() {
                const container = document.getElementById('historial-container');
                container.innerHTML = '';
                
                if (!this.estadoJuego.historial || this.estadoJuego.historial.length === 0) {
                    container.innerHTML = '<div class="historial-vacio">No hay jugadas a√∫n</div>';
                    return;
                }
                
                this.estadoJuego.historial.forEach(jugada => {
                    const item = document.createElement('div');
                    item.className = 'historial-item';
                    
                    const tiempo = new Date(jugada.timestamp).toLocaleTimeString();
                    const hoyoTexto = jugada.hoyo === 'boca' ? 'üê∏ Boca' : `Hoyo ${jugada.hoyo}`;
                    
                    item.innerHTML = `
                        <div class="jugada-info">
                            <span class="jugador">${jugada.jugadorNombre}</span>
                            <span class="hoyo">${hoyoTexto}</span>
                            <span class="puntos">+${jugada.puntos} pts</span>
                        </div>
                        <div class="tiempo">${tiempo}</div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            /**
             * üìä ACTUALIZAR ESTAD√çSTICAS
             */
            actualizarEstadisticas() {
                if (!this.estadoJuego.historial) return;
                
                // Total de jugadas
                document.getElementById('total-jugadas').textContent = this.estadoJuego.historial.length;
                
                // Puntuaci√≥n m√°xima
                const puntuacionMaxima = Math.max(...this.estadoJuego.jugadores.map(j => j.puntuacion));
                document.getElementById('puntuacion-maxima').textContent = puntuacionMaxima.toLocaleString();
                
                // L√≠der actual
                const lider = this.estadoJuego.jugadores.find(j => j.puntuacion === puntuacionMaxima);
                document.getElementById('lider-actual').textContent = lider ? lider.nombre : '-';
            }
            
            /**
             * üéâ MOSTRAR ANIMACI√ìN ESPECIAL
             */
            mostrarAnimacionEspecial(jugada) {
                // Crear elemento de celebraci√≥n
                const celebracion = document.createElement('div');
                celebracion.className = 'celebracion-especial';
                celebracion.innerHTML = `
                    <div class="celebracion-texto">
                        üéâ ¬°INCRE√çBLE! üéâ<br>
                        ${jugada.jugadorNombre}<br>
                        ${jugada.puntos} PUNTOS!
                    </div>
                `;
                
                celebracion.style.position = 'fixed';
                celebracion.style.top = '50%';
                celebracion.style.left = '50%';
                celebracion.style.transform = 'translate(-50%, -50%)';
                celebracion.style.zIndex = '2000';
                celebracion.style.backgroundColor = 'rgba(76, 175, 80, 0.95)';
                celebracion.style.color = 'white';
                celebracion.style.padding = '2rem';
                celebracion.style.borderRadius = '15px';
                celebracion.style.textAlign = 'center';
                celebracion.style.fontSize = '1.5rem';
                celebracion.style.fontWeight = 'bold';
                celebracion.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
                
                document.body.appendChild(celebracion);
                
                // Animar y remover
                setTimeout(() => {
                    celebracion.style.transform = 'translate(-50%, -50%) scale(1.1)';
                }, 100);
                
                setTimeout(() => {
                    celebracion.style.opacity = '0';
                    celebracion.style.transform = 'translate(-50%, -50%) scale(0.8)';
                }, 2000);
                
                setTimeout(() => {
                    if (document.body.contains(celebracion)) {
                        document.body.removeChild(celebracion);
                    }
                }, 2500);
            }
            
            /**
             * üì¢ MOSTRAR NOTIFICACI√ìN
             */
            mostrarNotificacion(mensaje, tipo = 'info') {
                const notificacion = {
                    id: Date.now(),
                    mensaje: mensaje,
                    tipo: tipo,
                    timestamp: new Date()
                };
                
                this.notificacionesActivas.push(notificacion);
                
                const container = document.getElementById('notificaciones-container');
                const elemento = document.createElement('div');
                elemento.className = `notificacion notificacion-${tipo}`;
                elemento.id = `notif-${notificacion.id}`;
                
                const iconos = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    info: '‚ÑπÔ∏è',
                    warning: '‚ö†Ô∏è'
                };
                
                elemento.innerHTML = `
                    <span class="notif-icono">${iconos[tipo]}</span>
                    <span class="notif-mensaje">${mensaje}</span>
                    <span class="notif-tiempo">${notificacion.timestamp.toLocaleTimeString()}</span>
                `;
                
                container.insertBefore(elemento, container.firstChild);
                
                // Auto-remover despu√©s de 5 segundos
                setTimeout(() => {
                    this.removerNotificacion(notificacion.id);
                }, 5000);
            }
            
            /**
             * üóëÔ∏è REMOVER NOTIFICACI√ìN
             */
            removerNotificacion(id) {
                const elemento = document.getElementById(`notif-${id}`);
                if (elemento) {
                    elemento.style.opacity = '0';
                    elemento.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        if (elemento.parentNode) {
                            elemento.parentNode.removeChild(elemento);
                        }
                    }, 300);
                }
                
                this.notificacionesActivas = this.notificacionesActivas.filter(n => n.id !== id);
            }
            
            /**
             * üßπ LIMPIAR NOTIFICACIONES VIEJAS
             */
            limpiarNotificacionesViejas() {
                const ahora = new Date();
                const tiempoLimite = 30000; // 30 segundos
                
                this.notificacionesActivas.forEach(notif => {
                    if (ahora - notif.timestamp > tiempoLimite) {
                        this.removerNotificacion(notif.id);
                    }
                });
            }
            
            /**
             * üîÑ ACTUALIZAR ESTADO DE CONEXI√ìN
             */
            actualizarEstadoConexion(estado) {
                const elemento = document.getElementById('estado-servidor');
                if (elemento) {
                    elemento.textContent = estado;
                }
            }
            
            /**
             * üìù LOG DE MENSAJES
             */
            log(mensaje) {
                console.log(`[APP-USUARIO] ${mensaje}`);
            }
        }
        
        // üöÄ INICIALIZAR APP CUANDO LA P√ÅGINA CARGA
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üì± Iniciando App Usuario...');
            const app = new AppUsuarioCyberSapo();
        });
    </script>
</body>
</html>
